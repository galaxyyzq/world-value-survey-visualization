<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  margin: 0 4px;
}


.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: steelblue;
}

.x.axis path {
  display: none;
}

.tooltip{
  text-anchor: middle;
  font-family: sans-serif;
  font-size: 10px;
  font-weight: bold;
  fill:black; 
}

label {
  position: absolute;
  top: 265px;
  right: 290px;
  color: #D8D8D8;
}

.tip{
  position: absolute;
  top: 430px;
  right: 290px;
}

	/*color: #81c2eb;*/
.button {  
    display: inline-block;  
    zoom: 1;  
    *display: inline;  
    vertical-align: baseline;  
    margin: 0 4px;  
    outline: none;  
    cursor: pointer;  
    text-align: center;  
    text-decoration: none;  
    font: 14px;  
    padding: .5em 0.6em .55em;   
    border-radius: .5em;  
    -webkit-box-shadow: 0 1px 1px rgba(0,0,0,.2);  
    -moz-box-shadow: 0 1px 1px rgba(0,0,0,.2);  
    box-shadow: 0 1px 1px rgba(0,0,0,.2);  
}  
.button:hover {  
    text-decoration: none;  
}  
.button:active {  
    position: relative;  
    top: 1px;  
}

h4 {
    display: block;
    -webkit-margin-before: 0.8em;
    -webkit-margin-after: 0.8em;
    -webkit-margin-start: 0px;
    -webkit-margin-end: 0px;
    font-weight: bold;
}

.report {
     font: 12px Helvetica;
     padding: 3em 43em 3em 3em;


}


</style>
<html>
<body>
<div class="body">
<h4>1995-1998:</h4>
  <a href="https://galaxyyzq.github.io/wvs/CSV/index.html" class="button">Work Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/family1995.html" class="button">Family Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/friends1995.html" class="button">Friends Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/leisure1995.html" class="button">Leisure time Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/politics1995.html" class="button">Politics Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/religion1995.html" class="button">Religion Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/happiness1995.html" class="button">Feeling about Happiness</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/health1995.html" class="button">State of Health</a>

<h4>1999-2004:</h4>
  <a href="https://galaxyyzq.github.io/wvs/CSV/work2000.html" class="button">Work Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/family2000.html" class="button">Family Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/friends2000.html" class="button">Friends Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/leisure2000.html" class="button">Leisure time Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/politics2000.html" class="button">Politics Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/religion2000.html" class="button">Religion Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/happiness2000.html" class="button">Feeling about Happiness</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/health2000.html" class="button">State of Health</a>

<h4>2005-2009:</h4>
  <a href="https://galaxyyzq.github.io/wvs/CSV/work2005.html" class="button">Work Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/family2005.html" class="button">Family Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/friends2005.html" class="button">Friends Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/leisure2005.html" class="button">Leisure time Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/politics2005.html" class="button">Politics Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/religion2005.html" class="button">Religion Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/happiness2005.html" class="button">Feeling about Happiness</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/health2005.html" class="button">State of Health</a>

<h4>2010-2014:</h4>
  <a href="https://galaxyyzq.github.io/wvs/CSV/work2010.html" class="button">Work Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/family2010.html" class="button">Family Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/friends2010.html" class="button">Friends Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/leisure2010.html" class="button">Leisure time Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/politics2010.html" class="button">Politics Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/religion2010.html" class="button">Religion Importance</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/happiness2010.html" class="button">Feeling about Happiness</a>
  <a href="https://galaxyyzq.github.io/wvs/CSV/health2010.html" class="button">State of Health</a>
  <!-- part 1 -->
  <!-- <button onClick="output()">test</button>   -->


  <h2>Importance in Life: Work 1995-1998</h2>


  <p>We use Country Abbreviations, please refer to http://sustainablesources.com/resources/country-abbreviations/</p>
  <p>percentage</p>
  
  <label><input type="checkbox"> Sort values</label>
  <p class="tip">click me↑</p>

<script src="d3.v3.min.js"></script>
<script>

var margin = {top: 10, right: 20, bottom: 20, left: 60},
    width = 1000 - margin.left - margin.right,
    height = 240 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width - 120], .1);

var y = d3.scale.linear()
    .rangeRound([height, 0]);

var color = d3.scale.ordinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".2s"));

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var active_link = "0"; //to control legend selections and hover
var legendClicked; //to control legend selections
var legendClassArray = []; //store legend classes to select bars in plotSingle()
var legendClassArray_orig = []; //orig (with spaces)
var sortDescending; //if true, bars are sorted by height in descending order
var restoreXFlag = false; //restore order of bars back to original


//disable sort checkbox
d3.select("label")             
  .select("input")
  .property("disabled", true)
  .property("checked", false); 



var fileArray=["work1995.csv","work1990.csv","work2000.csv","work2005.csv","work2010.csv"];


d3.csv(fileArray[0], function(error, data) {
  if (error) throw error;

  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "State"; }));

  data.forEach(function(d) {
    var mystate = d.State; //add to stock code
    var y0 = 0;
    //d.ages = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
    d.ages = color.domain().map(function(name) {
      //return { mystate:mystate, name: name, y0: y0, y1: y0 += +d[name]}; });
      return { 
        mystate:mystate, 
        name: name, 
        y0: y0, 
        y1: y0 += +d[name], 
        value: d[name],
        y_corrected: 0
      }; 
      });
    d.total = d.ages[d.ages.length - 1].y1;    

  });

  //Sort totals in descending order
  data.sort(function(a, b) { return b.total - a.total; });  

  x.domain(data.map(function(d) { return d.State; }));
  y.domain([0, d3.max(data, function(d) { return d.total; })]);

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end");
      //.text("Population");

  var state = svg.selectAll(".state")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + "0" + ",0)"; });
      //.attr("transform", function(d) { return "translate(" + x(d.State) + ",0)"; })

   height_diff = 0;  //height discrepancy when calculating h based on data vs y(d.y0) - y(d.y1)
   state.selectAll("rect")
      .data(function(d) {
        return d.ages; 
      })
    .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) {
        height_diff = 0;
        y_corrected = y(d.y1) + height_diff;
        d.y_corrected = y_corrected //store in d for later use in restorePlot()

        if (d.name === "Very important") height_diff = 0; //reset for next d.mystate
          
        return y_corrected;    
        // return y(d.y1);  //orig, but not accurate  
      })
      .attr("x",function(d) { //add to stock code
          return x(d.mystate)
        })
      .attr("height", function(d) {       
        //return y(d.y0) - y(d.y1); //heights calculated based on stacked values (inaccurate)
        return y(0) - y(d.value); //calculate height directly from value in csv file
      })
      .attr("class", function(d) {        
        classLabel = d.name.replace(/\s/g, ''); //remove spaces
        return "bars class" + classLabel;
      })
      .style("fill", function(d) { return color(d.name); });

  state.selectAll("rect")
       .on("mouseover", function(d){

          var delta = d.y1 - d.y0;
          var xPos = parseFloat(d3.select(this).attr("x"));
          var yPos = parseFloat(d3.select(this).attr("y"));
          var height = parseFloat(d3.select(this).attr("height"))

          d3.select(this).attr("stroke","blue").attr("stroke-width",0.8);

          svg.append("text")
          .attr("x",xPos)
          .attr("y",yPos +height/2)
          .attr("class","tooltip")
          .text(d.name +": "+ delta); 
          
       })
       .on("mouseout",function(){
          svg.select(".tooltip").remove();
          d3.select(this).attr("stroke","pink").attr("stroke-width",0.2);
                                
        })


  var legend = svg.selectAll(".legend")
      .data(color.domain().slice().reverse())
    .enter().append("g")
      .attr("class", function (d) {
        legendClassArray.push(d.replace(/\s/g, '')); //remove spaces
        legendClassArray_orig.push(d); //remove spaces
        return "legend";
      })
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  //reverse order to match order in which bars are stacked    
  legendClassArray = legendClassArray.reverse();
  legendClassArray_orig = legendClassArray_orig.reverse();

  legend.append("rect")
      .attr("x", width - 12)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color)
      .attr("id", function (d, i) {
        return "id" + d.replace(/\s/g, '');
      })
      .on("mouseover",function(){        

        if (active_link === "0") d3.select(this).style("cursor", "pointer");
        else {
          if (active_link.split("class").pop() === this.id.split("id").pop()) {
            d3.select(this).style("cursor", "pointer");
          } else d3.select(this).style("cursor", "auto");
        }
      })
      .on("click",function(d){        

        if (active_link === "0") { //nothing selected, turn on this selection
          d3.select(this)           
            .style("stroke", "black")
            .style("stroke-width", 2);

            active_link = this.id.split("id").pop();
            plotSingle(this);

            //gray out the others
            for (i = 0; i < legendClassArray.length; i++) {
              if (legendClassArray[i] != active_link) {
                d3.select("#id" + legendClassArray[i])
                  .style("opacity", 0.5);
              } else sortBy = i; //save index for sorting in change()
            }

            //enable sort checkbox
            d3.select("label").select("input").property("disabled", false)
            d3.select("label").style("color", "black")
            //sort the bars if checkbox is clicked            
            d3.select("input").on("change", change);  
           
        } else { //deactivate
          if (active_link === this.id.split("id").pop()) {//active square selected; turn it OFF
            d3.select(this)           
              .style("stroke", "none");
            
            //restore remaining boxes to normal opacity
            for (i = 0; i < legendClassArray.length; i++) {              
                d3.select("#id" + legendClassArray[i])
                  .style("opacity", 1);
            }

            
            if (d3.select("label").select("input").property("checked")) {              
              restoreXFlag = true;
            }
            
            //disable sort checkbox
            d3.select("label")
              .style("color", "#D8D8D8")
              .select("input")
              .property("disabled", true)
              .property("checked", false);   


            //sort bars back to original positions if necessary
            change();            

            //y translate selected category bars back to original y posn
            restorePlot(d);

            active_link = "0"; //reset
          }

        } //end active_link check
                          
                                
      });

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

// restore graph after a single selection
  function restorePlot(d) {
    //restore graph after a single selection
    d3.selectAll(".bars:not(.class" + class_keep + ")")
          .transition()
          .duration(1000)
          .delay(function() {
            if (restoreXFlag) return 3000;
            else return 750;
          })
          .attr("width", x.rangeBand()) //restore bar width
          .style("opacity", 1);

    //translate bars back up to original y-posn
    d3.selectAll(".class" + class_keep)
      .attr("x", function(d) { return x(d.mystate); })
      .transition()
      .duration(1000)
      .delay(function () {
        if (restoreXFlag) return 2000; //bars have to be restored to orig posn
        else return 0;
      })
      .attr("y", function(d) {
        //return y(d.y1); //not exactly correct since not based on raw data value
        return d.y_corrected; 
      });

    //reset
    restoreXFlag = false;
    
  }

  // plot only a single legend selection
  function plotSingle(d) {
        
    class_keep = d.id.split("id").pop();
    idx = legendClassArray.indexOf(class_keep);    
       
    //erase all but selected bars by setting opacity to 0
    d3.selectAll(".bars:not(.class" + class_keep + ")")
          .transition()
          .duration(1000)
          .attr("width", 0) // use because svg has no zindex to hide bars so can't select visible bar underneath
          .style("opacity", 0);

    //lower the bars to start on x-axis  
    state.selectAll("rect").forEach(function (d, i) {        
    
      //get height and y posn of base bar and selected bar
      h_keep = d3.select(d[idx]).attr("height");
      y_keep = d3.select(d[idx]).attr("y");  

      h_base = d3.select(d[0]).attr("height");
      y_base = d3.select(d[0]).attr("y");    

      h_shift = h_keep - h_base;
      y_new = y_base - h_shift;
 
      //reposition selected bars
      d3.select(d[idx])
        .transition()
        .ease("bounce")
        .duration(1000)
        .delay(750)
        .attr("y", y_new);

    })
   
  }
//adapted change() fn in http://bl.ocks.org/mbostock/3885705
  function change() {

    if (this.checked) sortDescending = true;
    else sortDescending = false;

    colName = legendClassArray_orig[sortBy];

    var x0 = x.domain(data.sort(sortDescending
        ? function(a, b) { return b[colName] - a[colName]; }
        : function(a, b) { return b.total - a.total; })
        .map(function(d,i) { return d.State; }))
        .copy();

    state.selectAll(".class" + active_link)
         .sort(function(a, b) { 
            return x0(a.mystate) - x0(b.mystate); 
          });

    var transition = svg.transition().duration(750),
        delay = function(d, i) { return i * 20; };

    //sort bars
    transition.selectAll(".class" + active_link)
      .delay(delay)
      .attr("x", function(d) {      
        return x0(d.mystate); 
      });      

    //sort x-labels accordingly    
    transition.select(".x.axis")
        .call(xAxis)
        .selectAll("g")
        .delay(delay);

   
    transition.select(".x.axis")
        .call(xAxis)
      .selectAll("g")
        .delay(delay);    
  }

});



function output()  
{  
  var selectMenu = document.getElementById("selectmenu");  
  console.log(selectMenu.value)
  
  d3.csv(fileArray[selectMenu.value], function(error, data) {
  if (error) throw error;

  color.domain(d3.keys(data[0]).filter(function(key) {return key !== "State"; }));

  data.forEach(function(d) {
    var mystate = d.State; //add to stock code
    var y0 = 0;
    //d.ages = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
    d.ages = color.domain().map(function(name) {
      //return { mystate:mystate, name: name, y0: y0, y1: y0 += +d[name]}; });
      return { 
        mystate:mystate, 
        name: name, 
        y0: y0, 
        y1: y0 += +d[name], 
        value: d[name],
        y_corrected: 0
      }; 
      });
    d.total = d.ages[d.ages.length - 1].y1;    

  });

  //Sort totals in descending order
  data.sort(function(a, b) { return b.total - a.total; });  

  x.domain(data.map(function(d) { return d.State; }));
  y.domain([0, d3.max(data, function(d) { return d.total; })]);

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end");
      //.text("Population");

  var state = svg.selectAll(".state")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + "0" + ",0)"; });
      //.attr("transform", function(d) { return "translate(" + x(d.State) + ",0)"; })

   height_diff = 0;  //height discrepancy when calculating h based on data vs y(d.y0) - y(d.y1)
   state.selectAll("rect")
      .data(function(d) {
        return d.ages; 
      })
    .enter().append("rect")
      .attr("width", x.rangeBand())
      .attr("y", function(d) {
        height_diff = 0;
        y_corrected = y(d.y1) + height_diff;
        d.y_corrected = y_corrected //store in d for later use in restorePlot()

        if (d.name === "Very important") height_diff = 0; //reset for next d.mystate
          
        return y_corrected;    
        // return y(d.y1);  //orig, but not accurate  
      })
      .attr("x",function(d) { //add to stock code
          return x(d.mystate)
        })
      .attr("height", function(d) {       
        //return y(d.y0) - y(d.y1); //heights calculated based on stacked values (inaccurate)
        return y(0) - y(d.value); //calculate height directly from value in csv file
      })
      .attr("class", function(d) {        
        classLabel = d.name.replace(/\s/g, ''); //remove spaces
        return "bars class" + classLabel;
      })
      .style("fill", function(d) { return color(d.name); });

  state.selectAll("rect")
       .on("mouseover", function(d){

          var delta = d.y1 - d.y0;
          var xPos = parseFloat(d3.select(this).attr("x"));
          var yPos = parseFloat(d3.select(this).attr("y"));
          var height = parseFloat(d3.select(this).attr("height"))

          d3.select(this).attr("stroke","blue").attr("stroke-width",0.8);

          svg.append("text")
          .attr("x",xPos)
          .attr("y",yPos +height/2)
          .attr("class","tooltip")
          .text(d.name +": "+ delta); 
          
       })
       .on("mouseout",function(){
          svg.select(".tooltip").remove();
          d3.select(this).attr("stroke","pink").attr("stroke-width",0.2);
                                
        })


  var legend = svg.selectAll(".legend")
      .data(color.domain().slice().reverse())
    .enter().append("g")
      .attr("class", function (d) {
        legendClassArray.push(d.replace(/\s/g, '')); //remove spaces
        legendClassArray_orig.push(d); //remove spaces
        return "legend";
      })
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  //reverse order to match order in which bars are stacked    
  legendClassArray = legendClassArray.reverse();
  legendClassArray_orig = legendClassArray_orig.reverse();

  legend.append("rect")
      .attr("x", width - 12)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color)
      .attr("id", function (d, i) {
        return "id" + d.replace(/\s/g, '');
      })
      .on("mouseover",function(){        

        if (active_link === "0") d3.select(this).style("cursor", "pointer");
        else {
          if (active_link.split("class").pop() === this.id.split("id").pop()) {
            d3.select(this).style("cursor", "pointer");
          } else d3.select(this).style("cursor", "auto");
        }
      })
      .on("click",function(d){        

        if (active_link === "0") { //nothing selected, turn on this selection
          d3.select(this)           
            .style("stroke", "black")
            .style("stroke-width", 2);

            active_link = this.id.split("id").pop();
            plotSingle(this);

            //gray out the others
            for (i = 0; i < legendClassArray.length; i++) {
              if (legendClassArray[i] != active_link) {
                d3.select("#id" + legendClassArray[i])
                  .style("opacity", 0.5);
              } else sortBy = i; //save index for sorting in change()
            }

            //enable sort checkbox
            d3.select("label").select("input").property("disabled", false)
            d3.select("label").style("color", "black")
            //sort the bars if checkbox is clicked            
            d3.select("input").on("change", change);  
           
        } else { //deactivate
          if (active_link === this.id.split("id").pop()) {//active square selected; turn it OFF
            d3.select(this)           
              .style("stroke", "none");
            
            //restore remaining boxes to normal opacity
            for (i = 0; i < legendClassArray.length; i++) {              
                d3.select("#id" + legendClassArray[i])
                  .style("opacity", 1);
            }

            
            if (d3.select("label").select("input").property("checked")) {              
              restoreXFlag = true;
            }
            
            //disable sort checkbox
            d3.select("label")
              .style("color", "#D8D8D8")
              .select("input")
              .property("disabled", true)
              .property("checked", false);   


            //sort bars back to original positions if necessary
            change();            

            //y translate selected category bars back to original y posn
            restorePlot(d);

            active_link = "0"; //reset
          }

        } //end active_link check
                          
                                
      });

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

// restore graph after a single selection
  function restorePlot(d) {
    //restore graph after a single selection
    d3.selectAll(".bars:not(.class" + class_keep + ")")
          .transition()
          .duration(1000)
          .delay(function() {
            if (restoreXFlag) return 3000;
            else return 750;
          })
          .attr("width", x.rangeBand()) //restore bar width
          .style("opacity", 1);

    //translate bars back up to original y-posn
    d3.selectAll(".class" + class_keep)
      .attr("x", function(d) { return x(d.mystate); })
      .transition()
      .duration(1000)
      .delay(function () {
        if (restoreXFlag) return 2000; //bars have to be restored to orig posn
        else return 0;
      })
      .attr("y", function(d) {
        //return y(d.y1); //not exactly correct since not based on raw data value
        return d.y_corrected; 
      });

    //reset
    restoreXFlag = false;
    
  }

  // plot only a single legend selection
  function plotSingle(d) {
        
    class_keep = d.id.split("id").pop();
    idx = legendClassArray.indexOf(class_keep);    
       
    //erase all but selected bars by setting opacity to 0
    d3.selectAll(".bars:not(.class" + class_keep + ")")
          .transition()
          .duration(1000)
          .attr("width", 0) // use because svg has no zindex to hide bars so can't select visible bar underneath
          .style("opacity", 0);

    //lower the bars to start on x-axis  
    state.selectAll("rect").forEach(function (d, i) {        
    
      //get height and y posn of base bar and selected bar
      h_keep = d3.select(d[idx]).attr("height");
      y_keep = d3.select(d[idx]).attr("y");  

      h_base = d3.select(d[0]).attr("height");
      y_base = d3.select(d[0]).attr("y");    

      h_shift = h_keep - h_base;
      y_new = y_base - h_shift;
 
      //reposition selected bars
      d3.select(d[idx])
        .transition()
        .ease("bounce")
        .duration(1000)
        .delay(750)
        .attr("y", y_new);

    })
   
  }
//adapted change() fn in http://bl.ocks.org/mbostock/3885705
  function change() {

    if (this.checked) sortDescending = true;
    else sortDescending = false;

    colName = legendClassArray_orig[sortBy];

    var x0 = x.domain(data.sort(sortDescending
        ? function(a, b) { return b[colName] - a[colName]; }
        : function(a, b) { return b.total - a.total; })
        .map(function(d,i) { return d.State; }))
        .copy();

    state.selectAll(".class" + active_link)
         .sort(function(a, b) { 
            return x0(a.mystate) - x0(b.mystate); 
          });

    var transition = svg.transition().duration(750),
        delay = function(d, i) { return i * 20; };

    //sort bars
    transition.selectAll(".class" + active_link)
      .delay(delay)
      .attr("x", function(d) {      
        return x0(d.mystate); 
      });      

    //sort x-labels accordingly    
    transition.select(".x.axis")
        .call(xAxis)
        .selectAll("g")
        .delay(delay);

   
    transition.select(".x.axis")
        .call(xAxis)
      .selectAll("g")
        .delay(delay);    
  }

});
   // alert(x.value);
   // alert(x.selectedIndex); 
}

</script>

</div>
<div class="report">
<h2>Analytic trail from this visualization</h2>

<h3>-Research question</h3>
<p> 
	In 2010-2014 which factor is the most important thing in the lives in people’s mind? and which country has the largest proportion of people to evaluate it as “very important”?
</p>
<h3>-General Cognition of this Page</h3>
<p> 
	This page contains two parts: One is the selection of all the statics we have, sorted by the time periods and topics. By clicking on the buttons we can easily access to all the statics. Another part is the interactive chart. It is a stacked full-bar chart with sorting function.
</p>
<h3>-Analytic Process and Results</h3>
<p> 
1.  Click all related buttons and have a glance of the views “Importance in Life: Work/Family/Friends/Leisure times/Politics/Religions 2010-2014”.
compare the proportion by eyes: which factor do people think is most important? 
</p>
<p>
2.  Clearly it is the “Family” that has the largest part of “Very important” and “Rather important”. 
</p>
<p>
3.  Click the “Very Important” legend, the chart filter out other answers. Then we can click “sort values”, the chart automatically sort the answers by the value. 
</p>
<p>
4.  Now as we can clearly see, the country that has the largest proportion of people to evaluate “family” as “very important” is India(IN).
</p>
<h2>Analytic trail from WVS</h2>
<p> 
	To see this part please go to  <a href="https://docs.google.com/document/d/1F4XVcKfiV3uItHmb-BXxkatqf0JhODqjuC8MpDKyOZw/edit">https://docs.google.com/document/d/1F4XVcKfiV3uItHmb-BXxkatqf0JhODqjuC8MpDKyOZw/edit</a>. This document also contains the whole analytic report with pictures.
</p>
<h2>Learnings</h2>
<p> 
1.  In 2010-2014, among all the factors “family” is what people value most. All the countries that in the visualization of “Importance in Life: Family 2010-2014” have a proportion of “very important” that larger than 80%. The country that has the largest proportion of “Very important” is India.

</p>
<p> 
2.  In China, the importance of family generally goes up as time goes by. However, it also has a apparent decline in 1999-2004. In 2010-2014 the proportion of “Very important” goes up to nearly 90%. Even in 1999-2004, the proportion of family is almost 60%.
</p>
<p> 
3.  Overall, we can conclude that people values “family” very much in most countries. Different countries have a different trend in this question. In China the trend generally goes up.
</p>
</div>
</body>
</html>








